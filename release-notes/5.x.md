# 5.11.0
## Upgrade OWASP DependencyCheck plugin to 9.0.2
This now requires that an environment variable is set for the NVD API Key

# 5.10.0

## Upgrade to spring-boot 3.2.0
This includes an [upgrade to Spring Boot 3.2.0](https://github.com/spring-projects/spring-boot/releases/tag/v3.2.0)

## Upgrade to Kotlin 1.9.21
This includes an [upgrade to Kotlin 1.9.21](https://github.com/JetBrains/kotlin/releases/tag/v1.9.21/)

## Upgrade notes

### Wiremock Jetty incompatibility
Spring Boot now defaults to Jetty 12. Wiremock 3.3 expects Jetty 11, which causes
```
java.lang.IncompatibleClassChangeError: class org.eclipse.jetty.http2.server.HttpChannelOverHTTP2 has interface org.eclipse.jetty.server.HttpChannel as super class
```
when wiremock starts up. The solution to this is to switch to the standalone version of wiremock, so
```kotlin
  testImplementation("org.wiremock:wiremock-standalone:3.3.1")
```
which therefore means that the jetty wiremock dependency is included in wiremock instead.

### Not found exceptions
API paths / resources that are not found now throw a `org.springframework.web.servlet.resource.NoResourceFoundException`.
This new exception needs to be caught by the exception handler
i.e.
```kotlin
  @ExceptionHandler(NoResourceFoundException::class)
  fun handleEntityNotFoundException(e: NoResourceFoundException): ResponseEntity<ErrorResponse> {
    return ResponseEntity
      .status(HttpStatus.NOT_FOUND)
      .contentType(MediaType.APPLICATION_JSON)
      .body(ErrorResponse(status = HttpStatus.NOT_FOUND.value(), developerMessage = e.message))
  }
```
otherwise a `500` internal server error will be thrown instead.

See https://github.com/spring-projects/spring-framework/issues/31569 for more information

## Version upgrades
 - com.github.ben-manes:gradle-versions-plugin [0.49.0 -> 0.50.0]
 - com.github.ben-manes.versions:com.github.ben-manes.versions.gradle.plugin [0.49.0 -> 0.50.0]
 - io.spring.dependency-management:io.spring.dependency-management.gradle.plugin [1.1.3 -> 1.1.4]
 - org.junit.jupiter:junit-jupiter [5.10.0 -> 5.10.1]
 - org.mockito:mockito-junit-jupiter [5.6.0 -> 5.7.0]
 - com.fasterxml.jackson.module:jackson-module-kotlin [2.15.3 -> 2.16.0]

# 5.9.0

## Version upgrades
This version upgrades reactor bill of materials for CVE-2023-34062.  See https://spring.io/security/cve-2023-34062 for more information.
 - reactor.bom [2022.0.12] -> [2023.0.0]
which then brings in
 - io.projectreactor.netty:reactor-netty-http [1.1.12 -> 1.1.13]
to fix the vulnerability.

# 5.8.0

## Upgrade to Kotlin 1.9.20
This includes an [upgrade to Kotlin 1.9.20](https://github.com/JetBrains/kotlin/releases/tag/v1.9.20/)

## Version upgrades
 - com.microsoft.azure:applicationinsights-agent [3.4.17 -> 3.4.18]
 - com.microsoft.azure:applicationinsights-core [3.4.17 -> 3.4.18]
 - io.opentelemetry:opentelemetry-api [1.30.1 -> 1.31.0]
 - org.owasp:dependency-check-core [8.4.0 -> 8.4.2]
 - org.owasp.dependencycheck:org.owasp.dependencycheck.gradle.plugin [8.4.0 -> 8.4.2]

# 5.7.0

## Upgrade to spring-boot 3.1.5
This includes an [upgrade to Spring Boot 3.1.5](https://github.com/spring-projects/spring-boot/releases/tag/v3.1.5)

## Version upgrades
- com.fasterxml.jackson.module:jackson-module-kotlin [2.15.2 -> 2.15.3]
- com.adarshr.test-logger:com.adarshr.test-logger.gradle.plugin [3.2.0 -> 4.0.0]

# 5.6.0

This is a fix version for the suppressions file for multi module gradle projects.
It was previously writing the suppressions file to each project directory, this change ensures it gets written
to the root of the multi module directory instead.

There is no change to functionality for non multi module gradle projects as the root and project directories
are the same.

## Version upgrades
None

## Suppressions
None

# 5.5.1

## Version upgrades
 - org.jlleitschuh.gradle.ktlint:org.jlleitschuh.gradle.ktlint.gradle.plugin [11.6.0 -> 11.6.1]
 - org.mockito:mockito-junit-jupiter [5.5.0 -> 5.6.0]
 - com.github.ben-manes:gradle-versions-plugin [0.48.0 -> 0.49.0]
 - io.opentelemetry:opentelemetry-api [1.29.0 -> 1.30.1]

## Suppressions
[CVE-2023-4586](https://nvd.nist.gov/vuln/detail/CVE-2023-4586) has now been released by NIST.  We now have to suppress all netty packages, not just netty-handler.

### Original suppression text from 4.11.1 release:
[CVE-2023-4586](https://ossindex.sonatype.org/vulnerability/CVE-2023-4586) resurrected a 5 year old [issue](https://github.com/netty/netty/issues/8537) with netty.
This was originally raised as [CWE-295](https://cwe.mitre.org/data/definitions/295.html)
and then in 2020 as [SNYK-JAVA-IONETTY-1042268](https://security.snyk.io/vuln/SNYK-JAVA-IONETTY-1042268).

Note that the vulnerability is in the default settings for netty handler.
It is a disputed vulnerability in that if clients configure netty correctly then there is no security issue.

I (Peter Phillips) have [searched](https://github.com/search?q=org%3Aministryofjustice%20io.netty.handler.ssl&type=code) our code base and haven't found any
instances of us configuring netty directly.  We instead rely on spring boot and other libraries to handle our connections and connect to other services.
Since the netty issue has been around now for nearly 5 years it is highly unlikely that libraries using netty handler are vulnerable and don't enable
hostname validation.  We can therefore suppress the vulnerability.

# 5.5.0

## Upgrade to spring-boot 3.1.4
This includes an [upgrade to Spring Boot 3.1.4](https://github.com/spring-projects/spring-boot/releases/tag/v3.1.4)

## Version upgrades
 - net.javacrumbs.json-unit:json-unit-assertj [3.0.0 -> 3.2.2]
 - org.jlleitschuh.gradle.ktlint:org.jlleitschuh.gradle.ktlint.gradle.plugin [11.5.1 -> 11.6.0]
 - com.microsoft.azure:applicationinsights-agent [3.4.16 -> 3.4.17]

# 5.4.1

## Version upgrades
 - com.github.ben-manes:gradle-versions-plugin [0.47.0 -> 0.48.0]
 - com.microsoft.azure:applicationinsights-agent [3.4.15 -> 3.4.16]
 - org.eclipse.jgit:org.eclipse.jgit [6.6.0.202305301015-r -> 6.7.0.202309050840-r]

## Suppressions
[CVE-2023-4586](https://ossindex.sonatype.org/vulnerability/CVE-2023-4586) resurrected a 5 year old [issue](https://github.com/netty/netty/issues/8537) with netty.
This was originally raised as [CWE-295](https://cwe.mitre.org/data/definitions/295.html)
and then in 2020 as [SNYK-JAVA-IONETTY-1042268](https://security.snyk.io/vuln/SNYK-JAVA-IONETTY-1042268).

Note that the vulnerability is in the default settings for netty handler.
It is a disputed vulnerability in that if clients configure netty correctly then there is no security issue.

I (Peter Phillips) have [searched](https://github.com/search?q=org%3Aministryofjustice%20io.netty.handler.ssl&type=code) our code base and haven't found any
instances of us configuring netty directly.  We instead rely on spring boot and other libraries to handle our connections and connect to other services.
Since the netty issue has been around now for nearly 5 years it is highly unlikely that libraries using netty handler are vulnerable and don't enable
hostname validation.  We can therefore suppress the vulnerability.

# 5.4.0

## Upgrade to spring-boot 3.1.3
This includes an [upgrade to Spring Boot 3.1.3](https://github.com/spring-projects/spring-boot/releases/tag/v3.1.3)

## Upgrade to Kotlin 1.9.10
This includes an [upgrade to Kotlin 1.9.10](https://github.com/JetBrains/kotlin/releases/tag/v1.9.10/)

## Version upgrades
 - com.gradle.plugin-publish [1.2.0 -> 1.2.1]
 - org.owasp.dependencycheck [8.3.1 -> 8.4.0]
 - org.jlleitschuh.gradle.ktlint [11.5.0 -> 11.5.1]
 - io.spring.dependency-management.gradle.plugin [1.1.2 -> 1.1.3]
 - org.owasp:dependency-check-core [8.3.1 -> 8.4.0]
 - com.microsoft.azure:applicationinsights-agent [3.4.14 -> 3.4.15]
 - io.opentelemetry:opentelemetry-api [1.27.0 -> 1.29.0]

## Test dependency upgrades
 - org.junit.jupiter:junit-jupiter [5.9.3 -> 5.10.0]
 - org.junit.vintage:junit-vintage-engine [5.9.3 -> 5.10.0]
 - org.mockito.kotlin:mockito-kotlin [5.0.0 -> 5.1.0]
 - org.mockito:mockito-junit-jupiter [5.4.0 -> 5.5.0]

# 5.3.0

Upgrades:

- Spring Boot 3.1.2
- Kotlin 1.9.0
- Ktlint 11.5.0
- io.spring.dependency-management.gradle.plugin 1.1.2
- json-unit-assertj 3.0.0# 5.2.4

## Suppression for CVE-2023-38286

From https://github.com/p1n93r/SpringBootAdmin-thymeleaf-SSTI we don't use Spring Boot Admin Server, MailNotifier or allow write access to the environment, thus are not affected.

## Suppression for CVE-2023-34036

From https://spring.io/security/cve-2023-34036 we don't produce hypermedia response with Spring reactiver web server using Spring HATEOAS, thus are not affected.

# 5.2.3

## Suppression for CVE-2023-3635

Suppressing pkg:maven/com.squareup.okio/okio@1.17.5 until a new version of the applicationinsights-agent is released, as this has started failing the owasp check and blocking the pipeline for https://github.com/ministryofjustice/hmpps-digital-prison-reporting-mi.

# 5.2.2

## Suppression for CVE-2023-35116

From https://github.com/FasterXML/jackson-databind/issues/3972 there is no vulnerability.  We certainly don't pass
untrusted json of infinite depth into jackson so can be ignored.

# 5.2.1

## Upgrade to spring-boot 3.1.1
This includes an [upgrade to Spring Boot 3.1.1](https://github.com/spring-projects/spring-boot/releases/tag/v3.1.1)

## Upgrade to Kotlin 1.8.22
This includes an [upgrade to Kotlin 1.8.22](https://github.com/JetBrains/kotlin/releases/tag/v1.8.22/)

## Guava
The guava implementation dependency has now been removed as it is unnecessary for kotlin projects
If needed then add
```
  implementation("com.google.guava:guava:32.0.1-jre")
```
to your build.gradle.kts file.

## Version upgrades
 - com.github.ben-manes.versions [0.46.0 -> 0.47.0]
 - org.owasp.dependencycheck [8.2.1 -> 8.3.1]
 - org.jlleitschuh.gradle.ktlint [11.3.2 -> 11.4.2]
 - org.owasp:dependency-check-core [8.2.1 -> 8.3.1]
 - com.fasterxml.jackson.module:jackson-module-kotlin [2.13.4 -> 2.15.2]
 - com.microsoft.azure:applicationinsights-agent [3.4.13 -> 3.4.14]
 - io.opentelemetry:opentelemetry-api [1.26.0 -> 1.27.0]

## Test dependency upgrades
 - org.mockito:mockito-junit-jupiter [5.3.1 -> 5.4.0]
 - org.eclipse.jgit:org.eclipse.jgit [6.6.0.202305301015-r -> 6.5.0.202303070854-r]
 - org.mockito.kotlin:mockito-kotlin [4.1.0 -> 5.0.0]

# 5.2.0

## Upgrade to Spring Boot 3.1.0

This includes an [upgrade to Spring Boot 3.1.0](https://github.com/spring-projects/spring-boot/releases/tag/v3.1.0)

## Fix Junit5 configuration

Since Gradle 8 any additional test source sets need the JUnit 5 configuration setting during the configuration phase, not the afterEvaluate phase. 

## Version upgrades

Applied agent dependencies:
 - com.microsoft.azure:applicationinsights-agent [3.4.12 -> 3.4.13]

Applied jar dependencies:
 - io.opentelemetry:opentelemetry-api [1.25.0 -> 1.26.0]
 - com.fasterxml.jackson.module:jackson-module-kotlin [2.14.2 -> 2.15.1]
 - com.google.guava:guava [31.0-jre -> 32.0.0-jre]

Applied test dependencies:
 - net.javacrumbs.json-unit:json-unit-assertj [2.37.0 -> 2.38.0]
 - org.junit.jupiter:junit-jupiter [5.9.2 -> 5.9.3]
 - org.junit.vintage:junit-vintage-engine [5.9.2 -> 5.9.3]

# 5.1.4

## Upgrade to Spring Boot 3.0.6

This includes an [upgrade to Spring Boot 3.0.6](https://github.com/spring-projects/spring-boot/releases/tag/v3.0.6)

## Upgrade to Kotlin 1.8.21

This includes an [upgrade to Kotlin 1.8.21](https://github.com/JetBrains/kotlin/releases/tag/v1.8.21/)

## Version upgrades

Applied jar dependencies:
- com.microsoft.azure:applicationinsights-agent [3.4.10 -> 3.4.12]
- io.opentelemetry:opentelemetry-api [1.24.0 -> 1.25.0]
- com.gradle.plugin-publish:com.gradle.plugin-publish.gradle.plugin [1.1.0 -> 1.2.0]

Applied test dependencies:
- org.mockito:mockito-junit-jupiter [5.2.0 -> 5.3.1]
- net.javacrumbs.json-unit:json-unit-assertj [2.36.1 -> 2.37.0]
- org.jlleitschuh.gradle.ktlint:org.jlleitschuh.gradle.ktlint.gradle.plugin [11.3.1 -> 11.3.2]

# 5.1.3

## Upgrade to spring-boot 3.0.5

This includes an [upgrade to Spring Boot 3.0.5](https://github.com/spring-projects/spring-boot/releases/tag/v3.0.5)

## Security updates

CVE-2023-1370 - false positive for accessors-smart 2.4.9. The vulnerability is in json-smart instead.

## Version upgrades

Applied jar dependencies:
 - org.springframework.boot:spring-boot-gradle-plugin [3.0.4 -> 3.0.5]
 - io.opentelemetry:opentelemetry-api [1.23.1 -> 1.24.0]


Applied test dependencies:
 - com.adarshr.test-logger:com.adarshr.test-logger.gradle.plugin [3.0.0 -> 3.2.0]
 - com.github.ben-manes:gradle-versions-plugin [0.42.0 -> 0.46.0]
 - com.github.ben-manes.versions:com.github.ben-manes.versions.gradle.plugin [0.42.0 -> 0.46.0]
 - org.eclipse.jgit:org.eclipse.jgit [6.4.0.202211300538-r -> 6.5.0.202303070854-r]
 - org.jlleitschuh.gradle.ktlint:org.jlleitschuh.gradle.ktlint.gradle.plugin [11.2.0 -> 11.3.1]
 - org.mockito:mockito-junit-jupiter [5.1.1 -> 5.2.0]
 - org.owasp:dependency-check-core [8.1.2 -> 8.2.1]
 - org.owasp:dependency-check-gradle [8.1.2 -> 8.2.1]
 - org.owasp.dependencycheck:org.owasp.dependencycheck.gradle.plugin [8.1.2 -> 8.2.1]

# 5.1.2

## Upgrade to spring-boot 3.0.4

This includes an [upgrade to Spring Boot 3.0.4](https://github.com/spring-projects/spring-boot/releases/tag/v3.0.4)

## Version upgrades

Fixes a bug with spring data native queries

# 5.1.1

## Upgrade to spring-boot 3.0.3

This includes an [upgrade to Spring Boot 3.0.3](https://github.com/spring-projects/spring-boot/releases/tag/v3.0.3)

## Version upgrades

Applied jar dependencies:
- com.microsoft.azure:applicationinsights-agent [3.4.8 -> 3.4.10]

Applied test dependencies:
- org.jlleitschuh.gradle.ktlint:org.jlleitschuh.gradle.ktlint.gradle.plugin [11.1.0 -> 11.2.0]
- com.github.ben-manes:gradle-versions-plugin [0.45.0 -> 0.46.0]
- org.owasp.dependencycheck:org.owasp.dependencycheck.gradle.plugin [7.4.3 -> 8.1.2]

# 5.1.0

## Upgrade to Kotlin 1.8.10

This includes an [upgrade to Kotlin 1.8.10](https://github.com/JetBrains/kotlin/releases/tag/v1.8.10/) which is a bugfix release.

## Version upgrades

None

# 5.0.1

## Suppressions for CVE-2022-45688
From the [CVE](https://nvd.nist.gov/vuln/detail/CVE-2022-45688) the vulnerability is in JSON-java / hutool-json v5.8.10 a dependency
in the notifications-java-client.  
It does not look like it uses the XML package in the [java client]( https://github.com/alphagov/notifications-java-client/search?q=json)   
This can then be suppressed.

## Suppressions for CVE-2008-7271 and CVE-2010-4647
Old vulnerabilities with wrong cpe that's incorrectly targetting jakarta.activation-api-2.1.1.jar

## Version upgrades

Applied plugin dependencies:
 - com.github.ben-manes:gradle-versions-plugin [0.44.0 -> 0.45.0]
 - com.github.ben-manes.versions:com.github.ben-manes.versions.gradle.plugin [0.44.0 -> 0.45.0]

Applied jar dependencies:
 - com.microsoft.azure:applicationinsights-agent [3.4.8 -> 3.4.9]
 - com.microsoft.azure:applicationinsights-core [3.4.8 -> 3.4.9]
 - com.fasterxml.jackson.module:jackson-module-kotlin [2.14.1 -> 2.14.2]

Applied test dependencies:
 - net.javacrumbs.json-unit:json-unit-assertj [2.36.0 -> 2.36.1]
 - org.jlleitschuh.gradle.ktlint:org.jlleitschuh.gradle.ktlint.gradle.plugin [11.0.0 -> 11.1.0]
 - org.mockito:mockito-junit-jupiter [5.0.0 -> 5.1.1]

# 5.0.0

## Upgrade to spring-boot 3.0.2
This includes an [upgrade to Spring Boot 3.0.2](https://github.com/spring-projects/spring-boot/releases/tag/v3.0.2)

## Upgrade to Kotlin 1.8.0
This includes an [upgrade to Kotlin 1.8.0](https://github.com/JetBrains/kotlin/releases/tag/v1.8.0/)

## HMPPS Spring Boot SQS Upgrade
Note that version 5 of the plugin requires that HMPPS Spring Boot SQS to be upgraded to at least 2.0.  This is because Spring Boot 3 uses JMS 2.0 rather than JMS 1.0 so the SQS plugin has been completely rewritten to use spring messaging instead and a different sqs library.

## Application Insights SQS Spring scheduling bug
There is a bug in application insights in that it fills up the logs with `InProc` dependencies - see https://github.com/microsoft/ApplicationInsights-Java/issues/2870.
To workaround this bug we have had to temporarily disable the collection of spring scheduling events within application insights - see https://github.com/ministryofjustice/offender-events-ui/blob/main/applicationinsights.json#L9-L11 for example code.

## Removal of old application insights SDK
The old version of application insights SDK shouldn't have been separately included.  It was superseded a while ago by
an application insights core dependency.  The new dependency doesn't integrate with spring boot so the TelemetryClient
needs to be created using the no args constructor and manually injected as a bean.  The java agent will then replace
the blank implementation at runtime.
This means that testing is easier as the bean will always exist and be a dummy implementation by default.

Furthermore, most calls (apart from custom events) can be replaced by calls to Span - see
[send custom telemetry](https://learn.microsoft.com/en-us/azure/azure-monitor/app/java-in-process-agent#send-custom-telemetry-by-using-the-application-insights-classic-sdk)
for more information.  Span has a dummy implementation by default too.

To now set the current `user_Id` in requests call
```kotlin
Span.current().setAttribute("enduser.id", it)
```

## Java 17 requirement
Starting from 5.0.0 we now target Java 17 instead of Java 11 with this plugin.

## Scripted upgrade
There is a script to help with the upgrade - see https://github.com/ministryofjustice/hmpps-tech-docs/blob/main/scripts/upgrade-spring-boot-3.bash

## Version upgrades

- org.jetbrains.kotlin:kotlin-reflect [1.7.21 -> 1.8.0]
- org.jetbrains.kotlin:kotlin-scripting-compiler-embeddable [1.7.21 -> 1.8.0]
- org.jetbrains.kotlin.jvm:org.jetbrains.kotlin.jvm.gradle.plugin [1.7.21 -> 1.8.0]
- com.fasterxml.jackson.module:jackson-module-kotlin [2.13.4 -> 2.14.1]

## Test upgrades

- org.owasp:dependency-check-core [7.3.2 -> 7.4.4]
- org.owasp:dependency-check-gradle [7.3.2 -> 7.4.4]
- org.owasp.dependencycheck:org.owasp.dependencycheck.gradle.plugin [7.3.2 -> 7.4.4]
- com.github.ben-manes.versions [0.42.0 -> 0.44.0]
- com.adarshr.test-logger [3.0.0 -> 3.2.0]
- org.mockito.kotlin:mockito-kotlin [4.0.0 -> 4.1.0]
- org.mockito:mockito-junit-jupiter [4.9.0 -> 4.11.0]
- org.eclipse.jgit:org.eclipse.jgit [6.3.0.202209071007-r -> 6.4.0.202211300538-r]
